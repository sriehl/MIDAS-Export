<?xml version="1.0"?>
<queries>
  <query name="org.billingsschools.midas.sections" coreTable="SECTIONS" flattened="true" tags="">
    <summary>MIDAS Sections</summary>
    <description>MIDAS Sections data</description>
    <columns>
      <column column="SECTIONS.ID">section_id</column>
      <column column="COURSES.ID">course_id</column>
      <column column="SECTIONS.SCHOOLID">school_id</column>
      <column column="PERIOD.ABBREVIATION">period_abbr</column>
      <column column="TERMS.ABBREVIATION">term_abbr</column>
      <column column="SECTION_MEETING.CYCLE_DAY_LETTER">day_name</column>
      <column column="SECTIONS.SECTION_NUMBER">section_num</column>
      <column column="SECTIONS.MAXENROLLMENT">max_enrollment</column>
      <column column="SECTIONS.MAXENROLLMENT">is_weighted</column>
      <column column="SECTIONS.COURSE_NUMBER">is_homeroom</column>
    </columns>
    <sql>
      <![CDATA[
        with config as (
          select
            t.yearid
          from
            terms t
          where
            t.id = (extract(year from sysdate) + case when extract(month from sysdate) >= 7 then 1 else 0 end - 1991) * 100
            and t.schoolid = 0
            and t.isyearrec = 1
        )

        select
            sections.id "section_id"
          , courses.id "course_id"
          , sections.schoolid "school_id"
          , period.abbreviation "period_abbr"
          , terms.abbreviation "term_abbr"
          , section_meeting.cycle_day_letter "day_name"
          , sections.section_number "section_num"
          , sections.maxenrollment "max_enrollment"
          , '0' "is_weighted"
          , case when sections.course_number in ('KD','1','2','3','4','5','WIN') then '1' else '0' end "is_homeroom"
        from
          sections
          left join courses
            on courses.course_number = sections.course_number
          left join terms
            on terms.id = sections.termid
            and terms.schoolid = sections.schoolid
          left join section_meeting
            on section_meeting.sectionid = sections.id
          left join period
            on period.period_number = section_meeting.period_number
            and period.schoolid = sections.schoolid
            and period.year_id = floor(sections.termid / 100)
        where
          floor(sections.termid / 100) = (select yearid from config)
      ]]>
    </sql>
  </query>
</queries>
