<?xml version="1.0"?>
<queries>
  <query name="org.billingsschools.midas.contact_email" coreTable="STUDENTS" flattened="true" tags="">
    <summary>MIDAS Contact Email</summary>
    <description>MIDAS Contact Email data</description>
    <columns>
      <column column="STUDENTS.ID">user_id</column>
      <column column="STUDENTS.ID">email</column>
      <column column="STUDENTS.ID">type_id</column>
      <column column="STUDENTS.ID">is_primary</column>
    </columns>
    <sql>
      <![CDATA[
        with studentemail as (
          select
            ssm.studentsdcid,
            psc.email
          from
            psm_studentcontact psc
            inner join sync_studentmap ssm
              on psc.studentid = ssm.studentid
            inner join psm_studentcontacttype psct
              on psc.studentcontacttypeid = psct.id
              and psct.name = 'Self'
              and psc.email is not null
        )

        select
            students.psguid "user_id"
          , student_email.email "email"
          , '7' "type_id"
          , '1' "is_primary"
        from
          (select * from studentemail) student_email
          left join students
            on students.dcid = student_email.studentsdcid
        where
          student_email.email is not null

        union all

        select
            users.psguid "user_id"
          , users.email_addr "email"
          , '4' "type_id"
          , '1' "is_primary"
        from
          users
      ]]>
    </sql>
  </query>
</queries>
